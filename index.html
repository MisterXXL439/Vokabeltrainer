<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Vokabeltrainer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; margin:0; display:flex; height:100vh; }
    nav { width:200px; background:#333; color:#fff; padding:10px; }
    nav h3 { color:#ffcc00; }
    nav button { display:block; margin:5px 0; width:100%; cursor:pointer; }
    main { flex:1; padding:20px; }
    #menu { display:none; }
    .hidden { display:none; }
    .vocabItem { padding:3px; cursor:pointer; display:inline-block; margin:3px; }
    .selected { background:#d0ffd0; }
  </style>
</head>
<body>
  <nav>
    <h3>Menü</h3>
    <div id="menu">
      <button onclick="showSection('trainer')">Trainer</button>
      <button onclick="showSection('progress')">Fortschritt</button>
      <button onclick="showSection('account')">Account</button>
      <button onclick="logout()">Logout</button>
    </div>
  </nav>
  <main>
    <!-- Anmeldung -->
    <section id="loginSection">
      <h2>Anmelden</h2>
      <input id="loginUser" placeholder="Benutzername"><br>
      <input id="loginPass" type="password" placeholder="Passwort"><br>
      <button onclick="login()">Login</button>
      <h3>Registrieren</h3>
      <input id="regUser" placeholder="Benutzername"><br>
      <input id="regPass" type="password" placeholder="Passwort"><br>
      <button onclick="register()">Registrieren</button>
    </section>

    <!-- Trainer -->
    <section id="trainerSection" class="hidden">
      <h2>Vokabeltrainer</h2>
      <p>Wähle Vokabeln (einzeln oder ganze Pages/Chapters):</p>
      <div id="selection"></div>
      <button onclick="startTraining()">Training starten</button>
      <div id="quiz" class="hidden">
        <h3 id="question"></h3>
        <input id="answer" placeholder="Antwort eingeben">
        <button onclick="checkAnswer()">OK</button>
        <p id="feedback"></p>
      </div>
    </section>

    <!-- Fortschritt -->
    <section id="progressSection" class="hidden">
      <h2>Fortschritt</h2>
      <div id="progressView"></div>
    </section>

    <!-- Account -->
    <section id="accountSection" class="hidden">
      <h2>Account verwalten</h2>
      <input id="newUsername" placeholder="Neuer Benutzername"><br>
      <input id="newPassword" type="password" placeholder="Neues Passwort"><br>
      <button onclick="updateAccount()">Speichern</button>
      <p id="accountMsg"></p>
    </section>
  </main>

<script>
  // ✅ Supabase-Initialisierung
  const SUPABASE_URL = "https://jciwcfpykwpsgigjkwza.supabase.co"; // <--- deine echte URL
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjaXdjZnB5a3dwc2dpZ2prd3phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzOTQzNDgsImV4cCI6MjA3NDk3MDM0OH0.djMNYfRGZvqiydLVTO41-aADH9dhj2zjkCWzbGaMEcQ";                  // <--- dein echter Anon-Key
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser=null;
  let vocab=[];
  let progress={};
  let selectedVocabs=new Set();
  let currentWord=null;

  function showSection(s){
    document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
    if(s==="trainer") document.getElementById("trainerSection").classList.remove("hidden");
    if(s==="progress"){ document.getElementById("progressSection").classList.remove("hidden"); showProgress(); }
    if(s==="account"){ document.getElementById("accountSection").classList.remove("hidden"); }
  }

  async function register(){
    const u=document.getElementById("regUser").value;
    const p=document.getElementById("regPass").value;
    const { error } = await supabase.from("users").insert([{username:u,password_hash:p,is_active:false}]);
    alert(error?"Fehler: "+error.message:"Registriert. Admin muss freischalten.");
  }

  async function login(){
    const u=document.getElementById("loginUser").value;
    const p=document.getElementById("loginPass").value;
    const { data, error } = await supabase.from("users").select("*")
      .eq("username",u).eq("password_hash",p).eq("is_active",true).single();
    if(error||!data){ alert("Login fehlgeschlagen"); return; }
    currentUser=data;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("menu").style.display="block";
    showSection("trainer");
    await loadVocab();
    await loadProgress();
    renderSelection();
  }

  function logout(){ location.reload(); }

  async function loadVocab(){
    const { data } = await supabase.from("vocab").select("*");
    vocab=data||[];
  }

  async function loadProgress(){
    const { data } = await supabase.from("progress").select("*").eq("user_id", currentUser.id);
    progress={};
    (data||[]).forEach(r=>{progress[r.vocab_id]={stage:r.stage,wrong_count:r.wrong_count}});
  }

  function renderSelection(){
    const div=document.getElementById("selection");
    div.innerHTML="";
    const chapters=[...new Set(vocab.map(v=>v.chapter))];
    chapters.forEach(ch=>{
      const chDiv=document.createElement("div");
      chDiv.innerHTML=`<b>Chapter ${ch}</b> <button onclick="selectChapter(${ch})">Alle auswählen</button>`;
      div.appendChild(chDiv);
      const pages=[...new Set(vocab.filter(v=>v.chapter===ch).map(v=>v.page))];
      pages.forEach(pg=>{
        const pgDiv=document.createElement("div");
        pgDiv.style.marginLeft="15px";
        pgDiv.innerHTML=`Page ${pg} <button onclick="selectPage(${ch},${pg})">Alle auswählen</button>`;
        div.appendChild(pgDiv);
        vocab.filter(v=>v.chapter===ch&&v.page===pg).forEach(v=>{
          const span=document.createElement("span");
          span.className="vocabItem";
          span.textContent=` ${v.en} - ${v.de}`;
          span.onclick=()=>toggleVocab(v.id,span);
          if(selectedVocabs.has(v.id)) span.classList.add("selected");
          pgDiv.appendChild(span);
        });
      });
    });
  }

  function toggleVocab(id,el){
    if(selectedVocabs.has(id)){ selectedVocabs.delete(id); el.classList.remove("selected"); }
    else{ selectedVocabs.add(id); el.classList.add("selected"); }
  }

  function selectChapter(ch){
    vocab.filter(v=>v.chapter===ch).forEach(v=>selectedVocabs.add(v.id));
    renderSelection();
  }
  function selectPage(ch,pg){
    vocab.filter(v=>v.chapter===ch&&v.page===pg).forEach(v=>selectedVocabs.add(v.id));
    renderSelection();
  }

  function startTraining(){
    if(selectedVocabs.size===0){ alert("Bitte Vokabeln wählen"); return; }
    document.getElementById("quiz").classList.remove("hidden");
    nextQuestion();
  }

  function nextQuestion(){
    const ids=[...selectedVocabs];
    currentWord=vocab.find(v=>v.id===ids[Math.floor(Math.random()*ids.length)]);
    document.getElementById("question").innerText=currentWord.en;
    document.getElementById("answer").value="";
    document.getElementById("feedback").innerText="";
  }

  async function checkAnswer(){
    const input=document.getElementById("answer").value.trim().toLowerCase();
    if(input===currentWord.de.toLowerCase()){
      let newStage=(progress[currentWord.id]?.stage||0)+1;
      let wrong=progress[currentWord.id]?.wrong_count||0;
      progress[currentWord.id]={stage:newStage,wrong_count:wrong};
      await supabase.from("progress").upsert([{user_id:currentUser.id,vocab_id:currentWord.id,stage:newStage,wrong_count:wrong}]);
      document.getElementById("feedback").innerText="✅ Richtig!";
    }else{
      let st=progress[currentWord.id]?.stage||0;
      let wrong=(progress[currentWord.id]?.wrong_count||0)+1;
      progress[currentWord.id]={stage:st,wrong_count:wrong};
      await supabase.from("progress").upsert([{user_id:currentUser.id,vocab_id:currentWord.id,stage:st,wrong_count:wrong}]);
      document.getElementById("feedback").innerText=`❌ Falsch! (${currentWord.de})`;
    }
    setTimeout(nextQuestion,1000);
  }

  function showProgress(){
    const c=document.getElementById("progressView");
    c.innerHTML="";
    const chapters=[...new Set(vocab.map(v=>v.chapter))];
    chapters.forEach(ch=>{
      const inCh=vocab.filter(v=>v.chapter===ch);
      const minStage=Math.min(...inCh.map(v=>progress[v.id]?.stage||0));
      const d=document.createElement("div");
      d.innerHTML=`<b>Chapter ${ch}</b> – Stufe ${minStage}`;
      d.onclick=()=>showPages(ch);
      c.appendChild(d);
    });
  }
  function showPages(ch){
    const c=document.getElementById("progressView"); c.innerHTML="";
    const pages=[...new Set(vocab.filter(v=>v.chapter===ch).map(v=>v.page))];
    pages.forEach(pg=>{
      const inPg=vocab.filter(v=>v.chapter===ch&&v.page===pg);
      const minStage=Math.min(...inPg.map(v=>progress[v.id]?.stage||0));
      const d=document.createElement("div");
      d.innerHTML=`Page ${pg} – Stufe ${minStage}`;
      d.onclick=()=>showVocabs(ch,pg);
      c.appendChild(d);
    });
  }
  function showVocabs(ch,pg){
    const c=document.getElementById("progressView"); c.innerHTML="";
    vocab.filter(v=>v.chapter===ch&&v.page===pg).forEach(v=>{
      const st=progress[v.id]?.stage||0;
      const d=document.createElement("div");
      d.innerText=`${v.en} – ${v.de} (Stufe ${st})`;
      c.appendChild(d);
    });
  }

  async function updateAccount(){
    const u=document.getElementById("newUsername").value;
    const p=document.getElementById("newPassword").value;
    const { error } = await supabase.from("users").update({username:u,password_hash:p}).eq("id",currentUser.id);
    document.getElementById("accountMsg").innerText=error?"Fehler":"Gespeichert!";
  }
</script>
</body>
</html>
