<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vokabeltrainer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f0f4f8; display:flex; height:100vh; }
nav { width:250px; background:#1a73e8; color:white; display:flex; flex-direction:column; padding:20px; display:none; }
nav h2 { margin-top:0; margin-bottom:20px; font-size:1.5em; }
nav a { color:white; text-decoration:none; margin:10px 0; font-size:1.1em; display:flex; align-items:center; }
nav a i { margin-right:10px; }
nav a:hover { color:#ffeb3b; }
main { flex:1; padding:30px; overflow-y:auto; }
h1 { color:#333; }
section { background:white; padding:20px; margin-bottom:20px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
input,select,button { font-size:1em; padding:8px 12px; margin:5px 0; border-radius:8px; border:1px solid #ccc; }
button { background:#1a73e8; color:white; border:none; cursor:pointer; }
button:hover { background:#1665c1; }
#progressBarContainer { width:100%; height:25px; background:#ddd; border-radius:15px; overflow:hidden; margin-top:15px; }
#progressBar { height:100%; background:#34a853; width:0%; transition:width 0.3s; }
#question { font-size:1.5em; color:#1a73e8; margin:20px 0; }
#feedback { font-size:1.2em; min-height:24px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px 12px; border-bottom:1px solid #ccc; text-align:left; }
th { cursor:pointer; }
.vocab-checkbox { margin-right:8px; }
</style>
</head>
<body>

<nav id="menu">
<h2><i class="fa-solid fa-book"></i> Menü</h2>
<a href="#" id="navTrainer"><i class="fa-solid fa-chalkboard"></i> Vokabeltrainer</a>
<a href="#" id="navProgress"><i class="fa-solid fa-chart-line"></i> Fortschritt</a>
<a href="#" id="navAccount"><i class="fa-solid fa-user"></i> Account verwalten</a>
<a href="#" id="navVocab"><i class="fa-solid fa-list"></i> Vokabeln nach Chapter</a>
</nav>

<main>
<section id="authSection">
<h1>Benutzerkonto</h1>
<input id="username" placeholder="Benutzername">
<input id="password" type="password" placeholder="Passwort"><br>
<button id="registerBtn">Registrieren</button>
<button id="loginBtn">Login</button>
<pre id="authOutput"></pre>
</section>

<section id="trainerSection" style="display:none;">
<h1>Vokabeltrainer</h1>
Richtung:
<select id="directionSelect">
<option value="en-de">Englisch → Deutsch</option>
<option value="de-en">Deutsch → Englisch</option>
</select>
Wiederholungen:
<select id="repeatSelect"></select>
<button id="startBtn">Start</button>

<div id="question"></div>
<input type="text" id="answer" placeholder="Antwort" disabled>
<div id="feedback"></div>
<div id="progressBarContainer"><div id="progressBar"></div></div>
</section>

<section id="progressSection" style="display:none;">
<h1>Fortschritt</h1>
<div id="progressContent">Lade Fortschritt...</div>
</section>

<section id="accountSection" style="display:none;">
<h1>Account verwalten</h1>
<input id="newUsername" placeholder="Neuer Benutzername">
<input id="newPassword" type="password" placeholder="Neues Passwort">
<button id="updateAccountBtn">Speichern</button>
<div id="accountContent"></div>
</section>

<section id="vocabSection" style="display:none;">
<h1>Vokabeln nach Chapter/Page</h1>
<select id="chapterSelect"><option value="">Alle Chapters</option></select>
<select id="pageSelect"><option value="">Alle Pages</option></select>
<div id="vocabList"></div>
</section>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = "https://jciwcfpykwpsgigjkwza.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjaXdjZnB5a3dwc2dpZ2prd3phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzOTQzNDgsImV4cCI6MjA3NDk3MDM0OH0.djMNYfRGZvqiydLVTO41-aADH9dhj2zjkCWzbGaMEcQ";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser=null, vocab=[], selectedVocabIds=[], richtigZaehler={}, falschZaehler={}, repeatTarget=3, currentWord=null, totalCorrect=0, totalAnswers=0, direction="en-de", quizActive=false;

// Navigation
document.getElementById("navTrainer").addEventListener("click", ()=>showSection("trainerSection"));
document.getElementById("navProgress").addEventListener("click", ()=>{showSection("progressSection"); loadProgress();});
document.getElementById("navAccount").addEventListener("click", ()=>{showSection("accountSection"); loadAccount();});
document.getElementById("navVocab").addEventListener("click", ()=>{showSection("vocabSection"); loadVocabSelection();});

function showSection(id){
  ["authSection","trainerSection","progressSection","accountSection","vocabSection"].forEach(s=>document.getElementById(s).style.display="none");
  document.getElementById(id).style.display="block";
}

// --- Auth ---
document.getElementById("registerBtn").addEventListener("click", async ()=>{
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value;
  if(!username||!password){ document.getElementById("authOutput").innerText="Bitte Benutzername und Passwort eingeben"; return; }
  const hashBuffer = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(password));
  const password_hash = Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
  const { data, error } = await supabase.from("users").insert([{username,password_hash,is_active:false}]).select();
  document.getElementById("authOutput").innerText = error?"Fehler: "+error.message:"Benutzer registriert, Admin muss freischalten";
});

document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value;
  if(!username||!password){ document.getElementById("authOutput").innerText="Bitte Benutzername und Passwort eingeben"; return; }
  const hashBuffer = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(password));
  const password_hash = Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
  const { data, error } = await supabase.from("users").select("*").eq("username",username).eq("password_hash",password_hash).eq("is_active",true).single();
  if(error){ document.getElementById("authOutput").innerText="Login fehlgeschlagen: "+error.message; return; }
  currentUser=data;
  document.getElementById("authOutput").innerText="Login erfolgreich! Willkommen "+currentUser.username;
  document.getElementById("menu").style.display="flex";
  await loadVocab();
});

// --- Account ---
document.getElementById("updateAccountBtn").addEventListener("click", async ()=>{
  if(!currentUser) return;
  const newUsername=document.getElementById("newUsername").value.trim()||currentUser.username;
  const newPassword=document.getElementById("newPassword").value;
  let updates={username:newUsername};
  if(newPassword){
    const hashBuffer=await crypto.subtle.digest("SHA-256", new TextEncoder().encode(newPassword));
    updates.password_hash=Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  const { data, error } = await supabase.from("users").update(updates).eq("id",currentUser.id).select();
  if(error){ document.getElementById("accountContent").innerText="Fehler: "+error.message; return; }
  currentUser=data[0];
  document.getElementById("accountContent").innerText="Daten erfolgreich aktualisiert!";
});

function loadAccount(){
  if(!currentUser) return;
  document.getElementById("newUsername").value=currentUser.username;
  document.getElementById("newPassword").value="";
  document.getElementById("accountContent").innerText="";
}

// --- Vokabeln & Auswahl ---
async function loadVocab(){
  const { data, error } = await supabase.from("vocab").select("*").order('chapter',{ascending:true});
  if(error){ console.error(error); return; }
  vocab=data;
}

function loadVocabSelection(){
  if(!vocab.length) return;
  const chapterSelect=document.getElementById("chapterSelect");
  const pageSelect=document.getElementById("pageSelect");
  const vocabList=document.getElementById("vocabList");

  const chapters=[...new Set(vocab.map(v=>v.chapter).sort((a,b)=>a-b))];
  chapterSelect.innerHTML=`<option value="">Alle Chapters</option>`+chapters.map(c=>`<option value="${c}">${c}</option>`).join("");

  chapterSelect.onchange=()=>{
    const chap=chapterSelect.value;
    const pages=[...new Set(vocab.filter(v=>!chap||v.chapter==chap).map(v=>v.page).sort((a,b)=>a-b))];
    pageSelect.innerHTML=`<option value="">Alle Pages</option>`+pages.map(p=>`<option value="${p}">${p}</option>`).join("");
    renderVocabList(chap,pageSelect.value);
  };

  pageSelect.onchange=()=>{
    renderVocabList(chapterSelect.value,pageSelect.value);
  };

  renderVocabList(chapterSelect.value,pageSelect.value);
}

function renderVocabList(chapter,page){
  const list=vocab.filter(v=>(!chapter||v.chapter==chapter)&&(!page||v.page==page));
  const container=document.getElementById("vocabList");
  container.innerHTML="";
  selectedVocabIds=[];
  list.forEach(v=>{
    const div=document.createElement("div");
    const checkbox=document.createElement("input");
    checkbox.type="checkbox";
    checkbox.className="vocab-checkbox";
    checkbox.value=v.id;
    checkbox.onchange=(e)=>{ 
      if(e.target.checked) selectedVocabIds.push(v.id);
      else selectedVocabIds=selectedVocabIds.filter(id=>id!==v.id);
    };
    div.appendChild(checkbox);
    div.appendChild(document.createTextNode(`${v.en} → ${v.de} (Chapter ${v.chapter}, Page ${v.page})`));
    container.appendChild(div);
  });
}

// --- Vokabeltrainer ---
document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("answer").addEventListener("keydown", e=>{if(e.key==="Enter") checkAnswer();});
for(let i=1;i<=5;i++){ document.getElementById("repeatSelect").innerHTML+=`<option value="${i}" ${i===3?'selected':''}>${i}</option>`; }

function resetCounters(){ 
  richtigZaehler={}; falschZaehler={};
  const trainSet=selectedVocabIds.length>0?vocab.filter(v=>selectedVocabIds.includes(v.id)):vocab;
  trainSet.forEach(v=>{richtigZaehler[v.id]=0; falschZaehler[v.id]=0;});
  totalCorrect=0; totalAnswers=0;
}

function pickRandomWord(){
  const trainSet=selectedVocabIds.length>0?vocab.filter(v=>selectedVocabIds.includes(v.id)):vocab;
  let remaining=trainSet.map(v=>v.id).filter(id=>richtigZaehler[id]<repeatTarget);
  if(remaining.length===0) return null;
  if(remaining.length>1 && currentWord!==null) remaining=remaining.filter(i=>i!==currentWord);
  return remaining[Math.floor(Math.random()*remaining.length)];
}

function startQuiz(){
  if(selectedVocabIds.length===0){ alert("Bitte zuerst Vokabeln auswählen"); return; }
  quizActive=true;
  document.getElementById("startBtn").disabled=true;
  document.getElementById("answer").disabled=false;
  document.getElementById("answer").focus();
  repeatTarget=parseInt(document.getElementById("repeatSelect").value);
  resetCounters();
  nextQuestion();
}

async function checkAnswer(){
  totalAnswers++;
  let input=document.getElementById("answer").value.trim().toLowerCase();
  let currentVocab=vocab.find(v=>v.id===currentWord);
  let correct=(direction==="en-de"?currentVocab.de.toLowerCase():currentVocab.en.toLowerCase());
  if(input===correct){
    richtigZaehler[currentWord]++;
    totalCorrect++;
    document.getElementById("feedback").innerText="✅ Richtig!";
    document.getElementById("feedback").style.color="green";
    await saveProgressToSupabase(currentWord,1,0);
  }else{
    falschZaehler[currentWord]++;
    document.getElementById("feedback").innerText=`❌ Falsch! Richtige Antwort: ${correct}`;
    document.getElementById("feedback").style.color="red";
    await saveProgressToSupabase(currentWord,0,1);
  }
  updateProgress();
  setTimeout(nextQuestion,1000);
}

function nextQuestion(){
  currentWord=pickRandomWord();
  if(currentWord===null){ endQuiz(); return; }
  let v=vocab.find(v=>v.id===currentWord);
  document.getElementById("question").innerText=(direction==="en-de"?v.en:v.de);
  document.getElementById("answer").value="";
  document.getElementById("answer").focus();
  document.getElementById("feedback").innerText="";
}

function updateProgress(){ 
  const totalTarget=selectedVocabIds.length>0?selectedVocabIds.length*repeatTarget:vocab.length*repeatTarget;
  const progress=Math.min(100,(totalCorrect/totalTarget)*100);
  document.getElementById("progressBar").style.width=progress+"%";
}

function endQuiz(){
  quizActive=false;
  document.getElementById("startBtn").disabled=false;
  document.getElementById("answer").disabled=true;
  document.getElementById("question").innerText="🎉 Alle Vokabeln geschafft! 🎉";
}

async function saveProgressToSupabase(vocabId,correct,wrong){
  if(!currentUser) return;
  const { data: existing } = await supabase.from("progress").select("*").eq("user_id",currentUser.id).eq("vocab_id",vocabId).single();
  if(existing){
    await supabase.from("progress").update({
      correct_count: existing.correct_count+correct,
      wrong_count: existing.wrong_count+wrong
    }).eq("id",existing.id);
  }else{
    await supabase.from("progress").insert([{user_id:currentUser.id,vocab_id:vocabId,correct_count:correct,wrong_count:wrong}]);
  }
}
</script>
</body>
</html>
